<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>投稿ガチャ</title>
<style>
  html,body{margin:0;background:#000;overflow:hidden;}
  .gc-root{width:100vw;height:100vh;position:relative;background:#000;display:flex;overflow:hidden;}
  .gc-bg{position:absolute;inset:0;background:
    radial-gradient(120% 120% at 50% -10%, #222 0%, #111 60%, #000 100%);
    z-index:0;}
  .gc-stage{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:1}

  /* カード */
  .gc-card{position:relative;display:flex;flex-direction:column;gap:12px;
    width:min(92vw,540px);padding:14px;border-radius:18px;background:#101014;
    box-shadow:0 20px 60px rgba(0,0,0,.45);}
  .gc-photo{width:100%;aspect-ratio:1/1;background:#222;border-radius:14px;overflow:hidden;
    display:flex;align-items:center;justify-content:center;}
  .gc-photo img{display:block;width:100%;height:100%;object-fit:cover;}
  .gc-text{color:#fff;font-size:clamp(14px,3.6vw,18px);line-height:1.5;word-break:break-word;}
  .gc-meta{display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .gc-tip{color:#fff;font-size:clamp(12px,3.2vw,14px);opacity:.85;}
  .gc-actions{display:flex;gap:10px;}
  .gc-btn{pointer-events:auto;border:0;border-radius:999px;cursor:pointer;background:#ffd166;color:#000;
    padding:clamp(10px,3vw,12px) clamp(16px,4.2vw,20px);font-size:clamp(14px,3.6vw,16px);
    box-shadow:0 8px 20px rgba(0,0,0,.35);}

  /* ステッカー（画像が無ければ自動で非表示） */
  .gc-sticker{position:absolute;z-index:6;right:calc(50% - min(46vw,270px));
    top:calc(50% - min(46vw,270px)); transform:translate(40%,-40%) rotate(-12deg);
    width:clamp(90px,26vw,160px);height:auto;pointer-events:none;filter:drop-shadow(0 8px 24px rgba(0,0,0,.4));}

  /* ローディング */
  .gc-loading{position:absolute;inset:0;z-index:4;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:#fff;}
  .gc-spin{width:56px;height:56px;border:5px solid rgba(255,255,255,.15);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .gc-loading p{margin:0;font-size:clamp(14px,3.6vw,16px);opacity:.85;}

  /* 紙吹雪 */
  .gc-confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:10;}
  .gc-confetti i{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.9;animation:fall 2.2s forwards ease-in;}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);}100%{transform:translateY(110vh) rotate(540deg);opacity:0;}}

  @supports(padding:max(0px)){
    .gc-root{
      padding-left:env(safe-area-inset-left);
      padding-right:env(safe-area-inset-right);
      padding-top:env(safe-area-inset-top);
      padding-bottom:env(safe-area-inset-bottom);
    }
  }
  .gc-root{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;
    -webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;}
  @media (min-width:769px){
    .gc-root{width:50vw;height:100vh;position:fixed;left:50%;top:0;transform:translateX(-50%);}
  }
  /* 失敗表示 */
  .gc-error{color:#fff;opacity:.9;text-align:center}
</style>
</head>
<body>
<div class="gc-root">
  <div class="gc-bg"></div>

  <div class="gc-stage">
    <!-- Loading -->
    <div id="gcLoading" class="gc-loading">
      <div class="gc-spin"></div>
      <p>ガチャを回転中…</p>
    </div>

    <!-- Sticker -->
    <img id="gcSticker" class="gc-sticker" alt="sticker" style="display:none;">

    <!-- Card -->
    <div id="gcCard" class="gc-card" style="display:none;">
      <div class="gc-photo">
        <img id="gcPhoto" alt="post photo" referrerpolicy="no-referrer">
      </div>
      <div id="gcText" class="gc-text"></div>
      <div class="gc-meta">
        <div class="gc-tip">スクリーンショットを保存してね！</div>
        <div class="gc-actions">
          <button id="btnAgain" class="gc-btn" title="もう一度投稿する">もう一度投稿する</button>
        </div>
      </div>
    </div>

    <div id="gcConfetti" class="gc-confetti"></div>
  </div>
</div>

<script>
  /* ---------- URL params ---------- */
  const params = new URLSearchParams(location.search);
  const spot = (params.get('spot') || 'veg').toLowerCase();  // veg / dairy / staple
  const sid  = params.get('sid') || '';

  /* ============ 必ず自分の URL に置き換え ============ */
  // Cloudflare Workers の URL（あなたの Web App を中継）
  const API_BASE = 'https://farm-gacha-proxy.zhuh49092.workers.dev';   // ← ここはあなたの Workers URL
  // 「もう一度投稿」ボタンの遷移先（Jotform の公開 URL）
  const FORM_URL = {
    veg:    'https://form.jotform.com/252481324905052',  // 例：veg
    dairy:  'https://form.jotform.com/252484053770054',  // 例：dairy
    staple: 'https://form.jotform.com/252483801287057'   // 例：staple
  };

  /* ---------- ステッカーの場所（画像は後で補充してOK） ---------- */
  const STICKER_DIR = {
    veg:    'assets/stickers/veg/',
    dairy:  'assets/stickers/dairy/',
    staple: 'assets/stickers/staple/'
  };
  const DEFAULT_STICKERS = ['lucky_01.png','lucky_02.png','lucky_03.png','lucky_04.png','lucky_05.png'];

  /* ---------- DOM ---------- */
  const loading  = document.getElementById('gcLoading');
  const card     = document.getElementById('gcCard');
  const photoImg = document.getElementById('gcPhoto');
  const textEl   = document.getElementById('gcText');
  const sticker  = document.getElementById('gcSticker');
  const ctnConf  = document.getElementById('gcConfetti');
  const btnAgain = document.getElementById('btnAgain');

  /* utilities */
  const rand = arr => arr[Math.floor(Math.random()*arr.length)];
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  function apiUrl(s){
    const base = `${API_BASE}?spot=${encodeURIComponent(s)}&mode=list`;
    return sid ? `${base}&sid=${encodeURIComponent(sid)}&t=${Date.now()}` : `${base}&t=${Date.now()}`;
  }

  async function fetchList(){
    try{
      const res = await fetch(apiUrl(spot), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      // list でも one でも受けられるように整形
      return Array.isArray(data) ? data : (data ? [data] : []);
    }catch(err){
      console.error('[gacha] fetch error:', err);
      return [];
    }
  }

  function pickStickerUrl(){
    const dir = STICKER_DIR[spot] || STICKER_DIR.veg;
    return dir + rand(DEFAULT_STICKERS);
  }

  /* confetti */
  let confettiTimer=null;
  function spawnConfettiBurst(k=12){
    const colors=['#ff7676','#ffd166','#06d6a0','#118ab2','#9b5de5','#f15bb5','#ffc6ff'];
    const w=ctnConf.clientWidth||720;
    for(let i=0;i<k;i++){
      const p=document.createElement('i');
      p.style.left=(Math.random()*w)+'px';
      p.style.background=colors[(Math.random()*colors.length)|0];
      p.style.animationDelay=(Math.random()*0.35)+'s';
      p.style.animationDuration=(1.8+Math.random()*1.4)+'s';
      p.addEventListener('animationend',()=>p.remove());
      ctnConf.appendChild(p);
    }
  }
  function startConfetti(totalMs=2400, intervalMs=160, perBurst=14){
    spawnConfettiBurst(perBurst);
    confettiTimer=setInterval(()=>spawnConfettiBurst(perBurst), intervalMs);
    setTimeout(()=>{clearInterval(confettiTimer);confettiTimer=null;}, totalMs);
  }

  function showError(msg){
    loading.innerHTML =
      `<div class="gc-spin" style="display:none"></div>
       <p class="gc-error">${msg}</p>`;
  }

  async function boot(){
    await sleep(500); // 小さく演出

    const list = await fetchList();
    if(!list.length){
      showError('読み込みに失敗しました。少し待ってリロードしてください。');
      return;
    }

    const post = rand(list);
    // 画像の“裂け”対策：cover + no-referrer（上で付与済）
    photoImg.src = post.img;
    textEl.textContent = post.text || '';

    // ステッカー（無ければ自動で消える）
    sticker.onerror = ()=>{sticker.style.display='none';};
    sticker.src = pickStickerUrl();
    sticker.style.display = 'block';

    loading.style.display = 'none';
    card.style.display = 'flex';
    startConfetti(2600, 160, 14);
  }

  btnAgain.addEventListener('click', ()=>{
    const url = (FORM_URL[spot] || FORM_URL.veg) + (sid ? `&fromsid=${encodeURIComponent(sid)}` : '');
    location.href = url;
  });

  boot();
</script>
</body>
</html>
