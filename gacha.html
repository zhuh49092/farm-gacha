<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>投稿ガチャ</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; background: #0f0f10; color: #eee; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, "Hiragino Sans", "Noto Sans JP", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      display: grid; place-items: center; min-height: 100dvh;
    }
    .card {
      width: min(92vw, 520px);
      background: #121315; border-radius: 24px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .photo {
      width: 100%; aspect-ratio: 1 / 1; background: #15161a; border-radius: 18px; overflow: hidden;
      display: grid; place-items: center; margin: 6px 0 16px;
    }
    .photo img { width: 100%; height: 100%; object-fit: contain; display: block; }
    .meta { font-size: 18px; margin-block: 12px 6px; }
    .hint { opacity: .7; font-size: 13px; }
    .btn {
      display: block; width: 100%; border: none; border-radius: 14px; padding: 16px 20px; margin-top: 16px;
      background: #eac66d; color: #3b2b06; font-weight: 700; font-size: 16px;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="photo"><img id="photo" alt="post photo" decoding="async" /></div>
    <div class="meta" id="text"></div>
    <div class="hint">スクリーンショットを保存してね！</div>
    <button class="btn" id="again">もう一度投稿する</button>
  </main>

  <script>
    // 你的 Workers 域
    const API_BASE = 'https://farm-gacha-proxy.zhuh49092.workers.dev';

    // 解析 query
    const qs = new URLSearchParams(location.search);
    const spot = (qs.get('spot') || 'veg').toLowerCase();
    const sid  = (qs.get('sid') || '').trim();

    const photo = document.getElementById('photo');
    const textEl = document.getElementById('text');
    const btn = document.getElementById('again');

    btn.onclick = () => location.reload();

    // 兜底：weserv（必须去掉协议，只传 host+path+search）
    const toWeserv = (rawUrl) => {
      try {
        const u = new URL(rawUrl);
        const hostPath = u.host + u.pathname + u.search;
        return 'https://images.weserv.nl/?url=' + encodeURIComponent(hostPath);
      } catch {
        // 解析失败就把协议去掉再传
        return 'https://images.weserv.nl/?url=' + encodeURIComponent(rawUrl.replace(/^https?:\/\//i, ''));
      }
    };

    // 安全设置图片：先 Worker /img，再失败兜底 weserv
    function setPhotoSafe(imgEl, rawUrl) {
      if (!rawUrl) {
        imgEl.removeAttribute('src');
        imgEl.onerror = null;
        imgEl.dataset.step = '';
        return;
      }
      imgEl.decoding = 'async';
      imgEl.loading = 'eager';
      imgEl.referrerPolicy = 'no-referrer';
      imgEl.crossOrigin = 'anonymous';
      delete imgEl.dataset.step;

      imgEl.onerror = () => {
        // 第一跳失败 -> weserv 兜底一次
        if (!imgEl.dataset.step) {
          imgEl.dataset.step = 'weserv';
          imgEl.src = toWeserv(rawUrl);
        }
      };

      // 第一跳走自己 Worker 的 /img 反代，避免直连跨域/防盗链
      imgEl.src = API_BASE + '/img?u=' + encodeURIComponent(rawUrl);
    }

    // 取列表，先带 sid（让 Apps Script 过滤自己），非 200 再尝试不带 sid
    async function fetchList() {
      const url = `${API_BASE}/?spot=${encodeURIComponent(spot)}&mode=list${sid ? `&sid=${encodeURIComponent(sid)}`:''}`;
      const res = await fetch(url, { credentials: 'omit' });
      let payload;
      try { payload = await res.json(); } catch { payload = { status: 500, data: { error: 'bad-json' } }; }

      if (payload && payload.status === 200 && Array.isArray(payload.data)) {
        return payload.data;
      }
      // 带 sid 返回了 400/空 -> 再试一次不带 sid（以免你本人那条被服务端过滤后没有候选）
      const url2 = `${API_BASE}/?spot=${encodeURIComponent(spot)}&mode=list`;
      const res2 = await fetch(url2, { credentials: 'omit' });
      try { payload = await res2.json(); } catch { payload = { status: 500, data: { error: 'bad-json' } }; }
      if (payload && payload.status === 200 && Array.isArray(payload.data)) {
        // 前端再自行过滤一次（保险），避免抽到自己
        if (sid) {
          return payload.data.filter(x => x && x.id && x.id !== sid || (x && !x.id));
        }
        return payload.data;
      }
      return [];
    }

    function pickOne(list) {
      if (!list || !list.length) return null;
      return list[Math.floor(Math.random() * list.length)];
    }

    async function boot() {
      const list = await fetchList();
      const item = pickOne(list);
      if (!item) {
        textEl.textContent = '投稿がまだ少ないみたい…';
        setPhotoSafe(photo, '');
        return;
      }
      textEl.textContent = item.text || '';
      setPhotoSafe(photo, item.img || '');
    }

    boot();
  </script>
</body>
</html>
