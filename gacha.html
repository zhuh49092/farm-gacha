<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>投稿ガチャ</title>
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; text-align:center; }
    .card { background:#111; margin:20px auto; padding:20px; border-radius:12px; max-width:400px; }
    img { max-width:100%; border-radius:8px; }
    button {
      background:#f2c94c; border:none; padding:10px 20px; border-radius:8px;
      font-size:16px; cursor:pointer; margin:10px;
    }
    #error { color:#f88; margin-top:10px; }
    canvas#confetti { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; }
  </style>
</head>
<body>

<h2>投稿ガチャ</h2>
<div class="card" id="result">読み込み中...</div>

<button onclick="reroll()">もう一回ガチャ</button>
<button onclick="location.href='https://docs.google.com/forms/...yourFormURL...'">もう一度投稿する</button>

<div id="error"></div>
<canvas id="confetti"></canvas>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbzohTsM5dhSUFTMTgc2c8OEoOJsIHZpz00aSl1FIgF6rjsS_MRPr_uWP1o-nlNttA0IVw/exec";

// 取得 URL パラメータ
const urlParams = new URLSearchParams(window.location.search);
const spot = urlParams.get("spot") || "veg";
const sid  = urlParams.get("sid") || "";

// 彩紙アニメーション
function fireConfetti() {
  const duration = 1500;
  const end = Date.now() + duration;
  (function frame() {
    confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } });
    confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } });
    if (Date.now() < end) requestAnimationFrame(frame);
  })();
}

// 投稿取得
async function getOne() {
  document.getElementById("result").textContent = "読み込み中...";
  document.getElementById("error").textContent = "";
  try {
    const API = `${API_BASE}?spot=${spot}&mode=list`;
    const r = await fetch(API);
    const j = await r.json();

    if (j.status === 200 && Array.isArray(j.data)) {
      // 自分の投稿を除外
      let list = j.data.filter(x => !sid || x.id !== sid);
      if (list.length === 0) list = j.data; // 全部除外された場合は全体にフォールバック

      const one = list[Math.floor(Math.random() * list.length)];
      document.getElementById("result").innerHTML = `
        <p><img src="${one.img}" alt="post photo"></p>
        <p>${one.text || "(no text)"}</p>
      `;
      fireConfetti();
    } else {
      document.getElementById("error").textContent = "データ取得エラー: " + JSON.stringify(j);
    }
  } catch (err) {
    console.error(err);
    document.getElementById("error").textContent = "ネットワークエラー: データを取得できません";
  }
}

function reroll() {
  getOne();
}

// 初回実行
getOne();
</script>

<!-- confetti library -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>
