<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>投稿ガチャ</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; background:#0b0b0e; color:#eaeaea; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      display:flex; justify-content:center; min-height:100dvh;
    }
    .wrap { width:min(560px, 92vw); padding:28px 0 40px; }
    .card {
      background:linear-gradient(180deg, #15161a, #101114);
      border-radius:20px; padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .photoBox {
      background:#121316; border-radius:16px; aspect-ratio:1/1; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    img.photo {
      width:100%; height:100%; object-fit:contain; display:block; image-rendering:auto;
    }
    .text { margin:16px 8px 4px; font-size:20px; line-height:1.5; }
    .hint { opacity:.7; font-size:14px; margin:12px 8px 22px; }
    .row { display:flex; gap:12px; }
    .btn {
      flex:1; padding:14px 16px; border-radius:999px; border:none; cursor:pointer;
      background:#f5c768; color:#221a03; font-weight:700; font-size:16px;
      box-shadow:0 8px 18px rgba(245,199,104,.28);
    }
    .loading { text-align:center; padding:40px 0; opacity:.8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="stage" class="card">
      <div class="photoBox">
        <img id="photo" class="photo" alt="post photo" />
      </div>
      <div id="text" class="text"></div>
      <div class="hint">スクリーンショットを保存してね！</div>
      <div class="row">
        <button id="retry" class="btn">もう一度投稿する</button>
      </div>
      <div id="loading" class="loading" style="display:none;">読み込み中...</div>
    </div>
  </div>

  <script>
    // 你的 Worker 域名（结尾要有 /）
    const API_BASE = 'https://farm-gacha-proxy.zhuh49092.workers.dev/';

    // 兜底转换
    const toWeserv = (u) => 'https://images.weserv.nl/?url=' + encodeURIComponent(u.replace(/^https?:\/\//,''));
    const toWorkerImg = (u) => API_BASE + 'img?u=' + encodeURIComponent(u);

    // 解析 URL 参数
    function qs(k, def='') {
      const v = new URLSearchParams(location.search).get(k);
      return v == null ? def : v;
    }
    const spot = (qs('spot','veg') + '').toLowerCase();
    const sid  = (qs('sid','') + '').trim();

    const $photo = document.getElementById('photo');
    const $text  = document.getElementById('text');
    const $loading = document.getElementById('loading');
    const $retry = document.getElementById('retry');

    function showLoading(on) { $loading.style.display = on ? '' : 'none'; }

    // 关键：图片安全加载（原图 -> Worker反代 -> weserv）
    function setPhotoSafe(imgEl, url) {
      imgEl.decoding = 'async';
      imgEl.loading = 'eager';
      imgEl.referrerPolicy = 'no-referrer';
      delete imgEl.dataset.step;

      imgEl.onerror = () => {
        if (!imgEl.dataset.step) {
          imgEl.dataset.step = 'worker';
          imgEl.src = toWorkerImg(url);      // 第一次失败：走 Worker
        } else if (imgEl.dataset.step === 'worker') {
          imgEl.dataset.step = 'weserv';
          imgEl.src = toWeserv(url);         // 仍失败：走 weserv
        } // 第三次失败则保持错误，不再死循环
      };

      imgEl.src = url; // 先尝试原图
    }

    async function fetchList() {
      const url = `${API_BASE}?spot=${encodeURIComponent(spot)}&mode=list${sid ? `&sid=${encodeURIComponent(sid)}` : ''}`;
      const r = await fetch(url, { cache: 'no-store' });
      const j = await r.json().catch(() => ({}));
      return j;
    }

    function pickOne(list) {
      return list.length ? list[Math.floor(Math.random() * list.length)] : null;
    }

    async function boot() {
      showLoading(true);
      try {
        const res = await fetchList();
        // 兼容 Apps Script/Worker 的响应格式：{ status, data }
        let list = Array.isArray(res) ? res : (res && res.data);
        if (!Array.isArray(list)) list = [];

        // 二次过滤：前端也排除 sid，确保“绝不会抽到自己”
        const my = sid;
        if (my) {
          list = list.filter(x =>
            x && x.img && ( !x.id || (x.id && String(x.id) !== String(my)) )
          );
        }

        const item = pickOne(list);
        if (!item) {
          $text.textContent = '投稿がまだ少ないみたい…';
          setPhotoSafe($photo, ''); // 清空
          showLoading(false);
          return;
        }

        // 渲染
        setPhotoSafe($photo, item.img);
        $text.textContent = item.text || '';
      } catch (e) {
        console.warn('[gacha] error ->', e);
        $text.textContent = '読み込みに失敗しました。再読み込みしてください。';
      } finally {
        showLoading(false);
      }
    }

    $retry.onclick = () => {
      const url = new URL(location.href);
      url.searchParams.set('t', Date.now().toString(36)); // cache buster
      location.href = url.toString();
    };

    boot();
  </script>
</body>
</html>
