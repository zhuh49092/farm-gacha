<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>投稿ガチャ</title>
<style>
  html,body{margin:0;background:#000;overflow:hidden;}
  .gc-root{width:100vw;height:100vh;position:relative;background:#000;display:flex;overflow:hidden;}
  /* 背景：用纯CSS渐变，避免外部图片依赖 */
  .gc-bg{position:absolute;inset:0;background:
    radial-gradient(120% 120% at 50% -10%, #222 0%, #111 60%, #000 100%);
    z-index:0;}
  .gc-stage{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:1}

  /* 卡片 */
  .gc-card{position:relative;display:flex;flex-direction:column;gap:12px;
    width:min(92vw,540px);padding:14px;border-radius:18px;background:#101014;
    box-shadow:0 20px 60px rgba(0,0,0,.45);}
  .gc-photo{width:100%;aspect-ratio:1/1;background:#222;border-radius:14px;overflow:hidden;
    display:flex;align-items:center;justify-content:center;}
  .gc-photo img{display:block;width:100%;height:100%;object-fit:cover;}
  .gc-text{color:#fff;font-size:clamp(14px,3.6vw,18px);line-height:1.5;word-break:break-word;}
  .gc-meta{display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .gc-tip{color:#fff;font-size:clamp(12px,3.2vw,14px);opacity:.85;}
  .gc-actions{display:flex;gap:10px;}
  .gc-btn{pointer-events:auto;border:0;border-radius:999px;cursor:pointer;background:#ffd166;color:#000;
    padding:clamp(10px,3vw,12px) clamp(16px,4.2vw,20px);font-size:clamp(14px,3.6vw,16px);
    box-shadow:0 8px 20px rgba(0,0,0,.35);}

  /* 贴纸 */
  .gc-sticker{position:absolute;z-index:6;right:calc(50% - min(46vw,270px));
    top:calc(50% - min(46vw,270px)); transform:translate(40%,-40%) rotate(-12deg);
    width:clamp(90px,26vw,160px);height:auto;pointer-events:none;filter:drop-shadow(0 8px 24px rgba(0,0,0,.4));}

  /* 加载：CSS spinner，避免 gif 依赖 */
  .gc-loading{position:absolute;inset:0;z-index:4;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:#fff;}
  .gc-spin{width:56px;height:56px;border:5px solid rgba(255,255,255,.15);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .gc-loading p{margin:0;font-size:clamp(14px,3.6vw,16px);opacity:.85;}

  /* 五彩纸屑 */
  .gc-confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:10;}
  .gc-confetti i{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.9;animation:fall 2.2s forwards ease-in;}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);}100%{transform:translateY(110vh) rotate(540deg);opacity:0;}}

  /* 安全区 & 禁选 */
  @supports(padding:max(0px)){
    .gc-root{
      padding-left:env(safe-area-inset-left);
      padding-right:env(safe-area-inset-right);
      padding-top:env(safe-area-inset-top);
      padding-bottom:env(safe-area-inset-bottom);
    }
  }
  .gc-root{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;
    -webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;}

  /* 桌面端收窄居中 */
  @media (min-width:769px){
    .gc-root{width:50vw;height:100vh;position:fixed;left:50%;top:0;transform:translateX(-50%);}
  }
</style>
</head>
<body>
<div class="gc-root">
  <div class="gc-bg"></div>

  <div class="gc-stage">
    <!-- 加载层 -->
    <div id="gcLoading" class="gc-loading">
      <div class="gc-spin"></div>
      <p>ガチャを回転中…</p>
    </div>

    <!-- 贴纸 -->
    <img id="gcSticker" class="gc-sticker" alt="sticker" style="display:none;">

    <!-- 卡片 -->
    <div id="gcCard" class="gc-card" style="display:none;">
      <div class="gc-photo"><img id="gcPhoto" alt="post photo"></div>
      <div id="gcText" class="gc-text"></div>
      <div class="gc-meta">
        <div class="gc-tip">スクリーンショットを保存してね！</div>
        <div class="gc-actions">
          <button id="btnAgain" class="gc-btn" title="もう一度投稿する">もう一度投稿する</button>
        </div>
      </div>
    </div>

    <div id="gcConfetti" class="gc-confetti"></div>
  </div>
</div>

<script>
  /* -------- URL 参数 -------- */
  const params = new URLSearchParams(location.search);
  const spot = (params.get('spot') || 'veg').toLowerCase();  // veg / dairy / staple
  const sid  = params.get('sid') || '';

  /* ====== 这里改为你的 Apps Script Web 应用地址（/exec 结尾） ====== */
  const API_BASE = 'https://farm-gacha-proxy.zhuh49092.workers.dev';

  /* -------- 外部数据源：改为调用 Apps Script（同时传 sid 排除自己） -------- */
  // 说明：保留 mode=list（一次取全，前端再随机）。若想省流量，可把 list 改为 one（后端直接随机），
  // 并保留下方对“数组/对象”的兼容判断。
  const DATA_MAP = {
    veg:    `${API_BASE}?spot=veg&mode=list${sid ? `&sid=${encodeURIComponent(sid)}` : ''}&t=${Date.now()}`,
    dairy:  `${API_BASE}?spot=dairy&mode=list${sid ? `&sid=${encodeURIComponent(sid)}` : ''}&t=${Date.now()}`,
    staple: `${API_BASE}?spot=staple&mode=list${sid ? `&sid=${encodeURIComponent(sid)}` : ''}&t=${Date.now()}`
  };

  /* -------- 内置假数据（兜底） -------- */
  const FALLBACK = {
    veg: [
      {"id":"v001","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%23A3D977'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23000' dy='.35em'>Carrot</text></svg>","text":"にんじんを見つけた！"},
      {"id":"v002","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%2390D26D'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23000' dy='.35em'>Cabbage</text></svg>","text":"キャベツが大きい〜"},
      {"id":"v003","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%23FF6B6B'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23fff' dy='.35em'>Tomato</text></svg>","text":"赤いトマトがおいしそう"}
    ],
    dairy: [
      {"id":"d001","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%23FFE28A'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23000' dy='.35em'>Egg</text></svg>","text":"まんまるたまご！"},
      {"id":"d002","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%23FFFFFF'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23000' dy='.35em'>Milk</text></svg>","text":"牛乳を飲んで元気いっぱい"},
      {"id":"d003","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%23F9C74F'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23000' dy='.35em'>Cheese</text></svg>","text":"チーズのいい匂い〜"}
    ],
    staple: [
      {"id":"s001","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%23E0C097'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23000' dy='.35em'>Bread</text></svg>","text":"おいしそうなパン！"},
      {"id":"s002","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%23F7F7F7'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23000' dy='.35em'>Rice</text></svg>","text":"白いごはん大好き"},
      {"id":"s003","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'><rect width='100%25' height='100%25' fill='%23F9844A'/><text x='50%25' y='50%25' font-size='64' text-anchor='middle' fill='%23000' dy='.35em'>Oil</text></svg>","text":"あぶらのびんを発見！"}
    ]
  };

  /* -------- 贴纸目录（本地图片） -------- */
  const STICKER_DIR = {
    veg:    'assets/stickers/veg/',
    dairy:  'assets/stickers/dairy/',
    staple: 'assets/stickers/staple/'
  };
  const DEFAULT_STICKERS = ['lucky_01.png','lucky_02.png','lucky_03.png','lucky_04.png','lucky_05.png'];

  /* -------- 再投稿按钮链接（替换为你的 Jotform 表单链接） -------- */
  const FORM_URL = {
    veg:    'https://form.jotform.com/252481324905052',   // ← 你已发布的 veg 表单（示例）
    dairy:  'https://form.jotform.com/252484053770054', // TODO: 换成你的 dairy 表单
    staple: 'https://form.jotform.com/252483801287057' // TODO: 换成你的 staple 表单
  };

  /* -------- DOM -------- */
  const loading  = document.getElementById('gcLoading');
  const card     = document.getElementById('gcCard');
  const photoImg = document.getElementById('gcPhoto');
  const textEl   = document.getElementById('gcText');
  const sticker  = document.getElementById('gcSticker');
  const ctnConf  = document.getElementById('gcConfetti');
  const btnAgain = document.getElementById('btnAgain');

  /* 工具 */
  const rand = arr => arr[Math.floor(Math.random()*arr.length)];
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  async function tryFetchJson(url){
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }catch(e){
      console.warn('[gacha] fetch failed, fallback to inline data:', url, e);
      return null;
    }
  }
  function pickStickerUrl(){
    const dir = STICKER_DIR[spot] || STICKER_DIR.veg;
    return dir + rand(DEFAULT_STICKERS);
  }

  /* 五彩纸屑 */
  let confettiTimer=null;
  function spawnConfettiBurst(k=12){
    const colors=['#ff7676','#ffd166','#06d6a0','#118ab2','#9b5de5','#f15bb5','#ffc6ff'];
    const w=ctnConf.clientWidth||720;
    for(let i=0;i<k;i++){
      const p=document.createElement('i');
      p.style.left=(Math.random()*w)+'px';
      p.style.background=colors[(Math.random()*colors.length)|0];
      p.style.animationDelay=(Math.random()*0.35)+'s';
      p.style.animationDuration=(1.8+Math.random()*1.4)+'s';
      p.addEventListener('animationend',()=>p.remove());
      ctnConf.appendChild(p);
    }
  }
  function startConfetti(totalMs=2400, intervalMs=160, perBurst=14){
    spawnConfettiBurst(perBurst);
    confettiTimer=setInterval(()=>spawnConfettiBurst(perBurst), intervalMs);
    setTimeout(()=>{clearInterval(confettiTimer);confettiTimer=null;}, totalMs);
  }

  async function boot(){
    // 模拟“转一转”
    await sleep(900);

    // 读取外部 JSON（Apps Script），失败就用内置假数据兜底
    const external = await tryFetchJson((DATA_MAP[spot] || DATA_MAP.veg));

    // 兼容：后端可能返回数组（mode=list）或对象（mode=one）
    let list;
    if (external && Array.isArray(external)) {
      list = external;
    } else if (external && typeof external === 'object') {
      list = [external];
    } else {
      list = null;
    }

    const finalList = (list && list.length) ? list : (FALLBACK[spot] || FALLBACK.veg);
    if(!finalList || !finalList.length){
      loading.querySelector('p').textContent = '読み込みに失敗しました。再読み込みしてください。';
      return;
    }

    const post = rand(finalList);
    photoImg.src = post.img;
    textEl.textContent = post.text || '';

    // 贴纸（若本地未放图，即使 404 也不影响主流程）
    sticker.onerror = () => { sticker.style.display='none'; };
    sticker.src = pickStickerUrl();
    sticker.style.display = 'block';

    loading.style.display = 'none';
    card.style.display = 'flex';
    startConfetti(2600, 160, 14);
  }

  btnAgain.addEventListener('click', ()=>{
    const url = (FORM_URL[spot] || FORM_URL.veg) + (sid ? `&fromsid=${encodeURIComponent(sid)}` : '');
    location.href = url;
  });

  boot();
</script>
</body>
</html>
