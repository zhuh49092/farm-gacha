<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>投稿ガチャ</title>
  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; padding:0; background:#0c0c0f; color:#eee; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif; }
    .wrap { min-height:100dvh; display:grid; place-items:center; padding:24px 16px; }
    .card { width:min(92vw, 720px); background:#141419; border-radius:24px; box-shadow:0 6px 20px rgba(0,0,0,.35); padding:20px 20px 16px; }
    .photoBox { background:#101014; border-radius:18px; overflow:hidden; aspect-ratio:1/1; display:grid; place-items:center; border:1px solid rgba(255,255,255,.06); }
    .photo { width:100%; height:100%; object-fit:cover; display:block; background:#0e0e12; }
    .caption { margin:14px 2px 4px; font-size:18px; line-height:1.45; color:#eaeaea; word-break:break-word; min-height:1lh; }
    .hint { margin:8px 2px 18px; font-size:13px; color:#b9b9c6; }
    .btn { -webkit-tap-highlight-color:transparent; cursor:pointer; width:100%; display:inline-flex; align-items:center; justify-content:center; gap:8px; height:56px; border-radius:16px; border:none; background:#e8c068; color:#262115; font-weight:700; font-size:16px; letter-spacing:.2px; box-shadow:0 6px 16px rgba(232,192,104,.28), inset 0 0 0 1px rgba(0,0,0,.15); }
    .btn:active { transform: translateY(1px); }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="photoBox">
        <img id="photo" class="photo" alt="post photo" />
      </div>
      <div id="caption" class="caption"></div>
      <div class="hint">スクリーンショットを保存してね！</div>
      <button id="again" class="btn">もう一度投稿する</button>
    </section>
  </main>

  <script>
    // 你的 Worker 根地址（不要带 query）
    const API_BASE = 'https://farm-gacha-proxy.zhuh49092.workers.dev';

    const qs   = new URLSearchParams(location.search);
    const SPOT = (qs.get('spot') || 'veg').toLowerCase();
    const SID  = (qs.get('sid')  || '').trim();

    // 统一生成两级兜底 URL
    const toWorkerImg = (url) => {
      const u = new URL(API_BASE + '/img');
      u.searchParams.set('u', url);
      return u.toString();
    };
    const toWeserv = (url) => 'https://images.weserv.nl/?url=' + encodeURIComponent(url);

    // 安全设置图片：先 Worker，再 weserv；没有 URL 就不发请求
    function setPhotoSafe(imgEl, rawUrl) {
      if (!rawUrl) {
        imgEl.removeAttribute('src');
        imgEl.onerror = null;
        imgEl.dataset.step = '';
        return;
      }
      imgEl.decoding = 'async';
      imgEl.loading = 'eager';
      imgEl.referrerPolicy = 'no-referrer';
      imgEl.crossOrigin = 'anonymous';
      delete imgEl.dataset.step;

      imgEl.onerror = () => {
        if (!imgEl.dataset.step) {
          imgEl.dataset.step = 'weserv';
          imgEl.src = toWeserv(rawUrl);
        }
      };

      // **先走 Worker 反代**
      imgEl.src = toWorkerImg(rawUrl);
    }

    // 带 sid 先请求，不带 sid 再兜底
    async function getList(spot, sid) {
      const withSid = new URL(API_BASE);
      withSid.searchParams.set('spot', spot);
      withSid.searchParams.set('mode', 'list');
      if (sid) withSid.searchParams.set('sid', sid);

      const r1 = await fetch(withSid.toString(), { cache: 'no-store' }).catch(() => null);
      if (r1 && r1.ok) {
        const j = await r1.json().catch(() => null);
        if (j && j.status === 200 && Array.isArray(j.data)) return j.data;
      }

      const noSid = new URL(API_BASE);
      noSid.searchParams.set('spot', spot);
      noSid.searchParams.set('mode', 'list');
      const r2 = await fetch(noSid.toString(), { cache: 'no-store' }).catch(() => null);
      if (r2 && r2.ok) {
        const j2 = await r2.json().catch(() => null);
        if (j2 && j2.status === 200 && Array.isArray(j2.data)) return j2.data;
      }
      return [];
    }

    // 保险：前端再过滤一次 sid
    function pickOne(list, sid) {
      if (!Array.isArray(list) || list.length === 0) return null;
      let arr = list;
      if (sid) {
        const filtered = list.filter(x => x && x.id && x.id !== sid);
        if (filtered.length > 0) arr = filtered;
      }
      return arr[Math.floor(Math.random() * arr.length)] || null;
    }

    async function boot() {
      const $photo   = document.getElementById('photo');
      const $caption = document.getElementById('caption');
      const $again   = document.getElementById('again');

      const list = await getList(SPOT, SID);
      if (!list || list.length === 0) {
        setPhotoSafe($photo, '');
        $caption.textContent = '投稿がまだ少ないみたい…';
        return;
      }

      const item = pickOne(list, SID) || list[0];
      setPhotoSafe($photo, item?.img || '');
      $caption.textContent = item?.text || '';

      $again.addEventListener('click', () => {
        history.back();
      }, { passive: true });
    }

    boot();
  </script>
</body>
</html>
