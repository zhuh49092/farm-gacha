<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>投稿ガチャ</title>
<style>
  html,body{margin:0;background:#000;overflow:hidden;}
  .gc-root{width:100vw;height:100vh;position:relative;background:#000;display:flex;overflow:hidden;}
  .gc-bg{position:absolute;inset:0;background:
    radial-gradient(120% 120% at 50% -10%, #222 0%, #111 60%, #000 100%);
    z-index:0;}
  .gc-stage{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:1}

  .gc-card{position:relative;display:flex;flex-direction:column;gap:12px;
    width:min(92vw,540px);padding:14px;border-radius:18px;background:#101014;
    box-shadow:0 20px 60px rgba(0,0,0,.45);}
  .gc-photo{width:100%;aspect-ratio:1/1;background:#222;border-radius:14px;overflow:hidden;
    display:flex;align-items:center;justify-content:center;}
  .gc-photo img{display:block;width:100%;height:100%;object-fit:cover;}
  .gc-text{color:#fff;font-size:clamp(14px,3.6vw,18px);line-height:1.5;word-break:break-word;}
  .gc-meta{display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .gc-tip{color:#fff;font-size:clamp(12px,3.2vw,14px);opacity:.85;}
  .gc-actions{display:flex;gap:10px;}
  .gc-btn{pointer-events:auto;border:0;border-radius:999px;cursor:pointer;background:#ffd166;color:#000;
    padding:clamp(10px,3vw,12px) clamp(16px,4.2vw,20px);font-size:clamp(14px,3.6vw,16px);
    box-shadow:0 8px 20px rgba(0,0,0,.35);}

  .gc-sticker{position:absolute;z-index:6;right:calc(50% - min(46vw,270px));
    top:calc(50% - min(46vw,270px)); transform:translate(40%,-40%) rotate(-12deg);
    width:clamp(90px,26vw,160px);height:auto;pointer-events:none;filter:drop-shadow(0 8px 24px rgba(0,0,0,.4));}

  .gc-loading{position:absolute;inset:0;z-index:4;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:#fff;}
  .gc-spin{width:56px;height:56px;border:5px solid rgba(255,255,255,.15);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .gc-loading p{margin:0;font-size:clamp(14px,3.6vw,16px);opacity:.85;}

  .gc-confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:10;}
  .gc-confetti i{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.9;animation:fall 2.2s forwards ease-in;}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);}100%{transform:translateY(110vh) rotate(540deg);opacity:0;}}

  @supports(padding:max(0px)){
    .gc-root{
      padding-left:env(safe-area-inset-left);
      padding-right:env(safe-area-inset-right);
      padding-top:env(safe-area-inset-top);
      padding-bottom:env(safe-area-inset-bottom);
    }
  }
  .gc-root{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;
    -webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;}
  @media (min-width:769px){
    .gc-root{width:50vw;height:100vh;position:fixed;left:50%;top:0;transform:translateX(-50%);}
  }
</style>
</head>
<body>
<div class="gc-root">
  <div class="gc-bg"></div>

  <div class="gc-stage">
    <div id="gcLoading" class="gc-loading">
      <div class="gc-spin"></div>
      <p id="gcMsg">ガチャを回転中…</p>
    </div>

    <img id="gcSticker" class="gc-sticker" alt="sticker" style="display:none;">

    <div id="gcCard" class="gc-card" style="display:none;">
      <div class="gc-photo"><img id="gcPhoto" alt="post photo" referrerpolicy="no-referrer"></div>
      <div id="gcText" class="gc-text"></div>
      <div class="gc-meta">
        <div class="gc-tip">スクリーンショットを保存してね！</div>
        <div class="gc-actions">
          <button id="btnAgain" class="gc-btn" title="もう一度投稿する">もう一度投稿する</button>
        </div>
      </div>
    </div>

    <div id="gcConfetti" class="gc-confetti"></div>
  </div>
</div>

<script>
  const params = new URLSearchParams(location.search);
  const spot = (params.get('spot') || 'veg').toLowerCase();
  const sid  = params.get('sid') || '';

  // Worker 根地址
  const API_BASE = 'https://farm-gacha-proxy.zhuh49092.workers.dev';

  // 首选：带 sid；回退：不带 sid
  const urlWithSid    = s => `${API_BASE}?spot=${s}&mode=list${sid ? `&sid=${encodeURIComponent(sid)}` : ''}&t=${Date.now()}`;
  const urlWithoutSid = s => `${API_BASE}?spot=${s}&mode=list&t=${Date.now()}`;

  const STICKER_DIR = {
    veg:    'assets/stickers/veg/',
    dairy:  'assets/stickers/dairy/',
    staple: 'assets/stickers/staple/'
  };
  const DEFAULT_STICKERS = ['lucky_01.png','lucky_02.png','lucky_03.png','lucky_04.png','lucky_05.png'];

  const FORM_URL = {
    veg:    'https://form.jotform.com/252481324905052',
    dairy:  'https://form.jotform.com/252484053770054',
    staple: 'https://form.jotform.com/252483801287057'
  };

  const loading  = document.getElementById('gcLoading');
  const msgEl    = document.getElementById('gcMsg');
  const card     = document.getElementById('gcCard');
  const photoImg = document.getElementById('gcPhoto');
  const textEl   = document.getElementById('gcText');
  const sticker  = document.getElementById('gcSticker');
  const ctnConf  = document.getElementById('gcConfetti');
  const btnAgain = document.getElementById('btnAgain');

  const rand  = arr => arr[Math.floor(Math.random()*arr.length)];
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  async function tryFetchJson(url){
    const res  = await fetch(url,{cache:'no-store'});
    const text = await res.text();
    if(!res.ok){
      // 静默处理，不在控制台报警 // NEW
      throw new Error('HTTP '+res.status);
    }
    try{
      return JSON.parse(text);
    }catch(_){
      // 某些场景 Apps Script 会把 JSON 作为字符串再包一层
      try{
        const maybe = JSON.parse(text);
        if(typeof maybe === 'string') return JSON.parse(maybe);
        return maybe;
      }catch(e2){
        throw e2;
      }
    }
  }

  // 兼容多种返回外形
  function unwrapList(payload){
    if(Array.isArray(payload)) return payload;
    if(payload && typeof payload === 'object'){
      if(Array.isArray(payload.data)) return payload.data;
      if(typeof payload.data === 'string'){
        try{
          const d = JSON.parse(payload.data);
          if(Array.isArray(d)) return d;
          if(d && Array.isArray(d.data)) return d.data;
        }catch(_){}
      }
      if(Array.isArray(payload.result)) return payload.result;
      if(Array.isArray(payload.items))  return payload.items;
      if(payload.status && payload.status !== 200) return []; // NEW：错误时返回空，触发降级
    }
    if(typeof payload === 'string'){
      try{ return unwrapList(JSON.parse(payload)); }catch(_){}
    }
    return null;
  }

  const pickStickerUrl = () => (STICKER_DIR[spot] || STICKER_DIR.veg) + rand(DEFAULT_STICKERS);

  // NEW：只在文件真实存在时才设置 <img>，避免 404 噪音
  async function safeSetSticker(){
    try{
      const url = pickStickerUrl();
      const r = await fetch(url, { method:'HEAD', cache:'no-store' });
      if(r.ok){
        sticker.src = url;
        sticker.style.display = 'block';
      }else{
        sticker.style.display = 'none';
      }
    }catch(_){
      sticker.style.display = 'none';
    }
  }

  // NEW：统一做“前端自过滤”，即便后端没过滤也能避免抽到自己
  const stripSelf = (list, sid) => {
    if(!sid) return list;
    const s = String(sid).trim();
    return list.filter(x => !x || !x.id ? true : String(x.id).trim() !== s);
  };

  // 无声降级：先带 sid，失败或空再不带 sid
  async function getListFor(s){
    try{
      const l1 = unwrapList(await tryFetchJson(urlWithSid(s)));
      if(l1 && l1.length) return l1;
    }catch(_){}
    try{
      const l2 = unwrapList(await tryFetchJson(urlWithoutSid(s)));
      return Array.isArray(l2) ? l2 : [];
    }catch(_){
      return [];
    }
  }

  async function boot(){
    try{
      await sleep(120);
      let list = await getListFor(spot);

      // 先做本地“去自己” // NEW
      list = stripSelf(list, sid);

      if(!list || !list.length){
        msgEl.textContent = '読み込みに失敗しました。再読み込みしてください。';
        return;
      }

      const post = rand(list);
      if(!post || !post.img){
        msgEl.textContent = '投稿データが不正です。';
        return;
      }

      photoImg.src = post.img;          // 直链展示
      textEl.textContent = post.text || '';

      await safeSetSticker();            // NEW：仅当贴纸存在时才展示

      loading.style.display = 'none';
      card.style.display = 'flex';
      startConfetti(2600, 160, 14);
    }catch(_){
      msgEl.textContent = '読み込みに失敗しました。再読み込みしてください。';
    }
  }

  let confettiTimer=null;
  function spawnConfettiBurst(k=12){
    const colors=['#ff7676','#ffd166','#06d6a0','#118ab2','#9b5de5','#f15bb5','#ffc6ff'];
    const w=ctnConf.clientWidth||720;
    for(let i=0;i<k;i++){
      const p=document.createElement('i');
      p.style.left=(Math.random()*w)+'px';
      p.style.background=colors[(Math.random()*colors.length)|0];
      p.style.animationDelay=(Math.random()*0.35)+'s';
      p.style.animationDuration=(1.8+Math.random()*1.4)+'s';
      p.addEventListener('animationend',()=>p.remove());
      ctnConf.appendChild(p);
    }
  }
  function startConfetti(totalMs=2400, intervalMs=160, perBurst=14){
    spawnConfettiBurst(perBurst);
    confettiTimer=setInterval(()=>spawnConfettiBurst(perBurst), intervalMs);
    setTimeout(()=>{clearInterval(confettiTimer);confettiTimer=null;}, totalMs);
  }

  btnAgain.addEventListener('click', ()=>{
    const url = (FORM_URL[spot] || FORM_URL.veg) + (sid ? `&fromsid=${encodeURIComponent(sid)}` : '');
    location.href = url;
  });

  boot();
</script>
</body>
</html>
