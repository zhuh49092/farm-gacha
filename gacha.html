<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>ガチャ</title>
  <style>
    :root { color-scheme: dark; }
    body{
      margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "PingFang SC", "Hiragino Sans", "Microsoft YaHei", sans-serif;
      background:#0b0b0f; color:#ddd; display:flex; justify-content:center;
    }
    .wrap{ width:min(680px, 96vw); padding:20px 0 32px; }
    .card{
      position:relative; margin:16px 16px 10px; border-radius:18px; background:#121217; box-shadow:0 10px 30px rgba(0,0,0,.35);
      min-height:60vh; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #1e1e27;
    }
    .ph{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      color:#555; font-size:14px; letter-spacing:.1em;
    }
    .imgBox{ position:relative; width:100%; aspect-ratio:1/1; max-height:80vh; }
    .imgBox img{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; object-position:center center; border-radius:18px;
      background:#0f0f14;
    }
    .txt{
      margin:8px 20px 4px; color:#dcdcdc; font-size:18px; line-height:1.5; min-height:1.5em;
      word-break:break-word; white-space:pre-wrap;
    }
    .note{ margin:6px 20px 22px; font-size:12px; color:#8a8a95; }
    .row{ display:flex; gap:12px; align-items:center; margin:16px 16px 0; }
    .btn{
      appearance:none; border:none; border-radius:14px; padding:16px 20px; font-weight:700; font-size:16px;
      background:#e9c05a; color:#231a00; cursor:pointer; flex:1; box-shadow:0 7px 20px rgba(233,192,90,.35);
    }
    .btn:disabled{ opacity:.55; cursor:default; }
    .err{ margin:12px 20px 0; color:#ff7c7c; font-size:14px; }
    .muted{ color:#8c8c98; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="ph" id="ph">読み込み中…</div>
      <div class="imgBox" id="imgBox" hidden>
        <img id="photo" alt="post photo">
      </div>
    </div>
    <div class="txt" id="text"></div>
    <div class="note">スクリーンショットを保存してね！</div>
    <div class="row">
      <button class="btn" id="again">もう一度投稿する</button>
    </div>
    <div class="err" id="err" hidden></div>
    <div class="note muted" id="debug" hidden></div>
  </div>

  <script>
    // 你的 Google Script /exec 地址（必填）
    const GOOGLE_SCRIPT = 'https://script.google.com/macros/s/AKfycbzIV32CTWpgHjtNBeQyt3BGhMHGhqxxFcDBTvWKlTd2utmvXRXKthp-W92qhLu4PPDllw/exec';

    // 可选：图片代理（当直链加载失败时自动回退一次）
    const IMG_PROXY = (u) => `https://images.weserv.nl/?url=${encodeURIComponent(u)}`;

    // 解析 URL 参数
    const urlParams = new URLSearchParams(location.search);
    const spot = (urlParams.get('spot') || 'veg').toLowerCase();
    const sid  = (urlParams.get('sid')  || '').trim();

    // 主要节点
    const ph    = document.getElementById('ph');
    const imgEl = document.getElementById('photo');
    const imgBox= document.getElementById('imgBox');
    const txtEl = document.getElementById('text');
    const errEl = document.getElementById('err');
    const dbgEl = document.getElementById('debug');
    const again = document.getElementById('again');

    let pool = [];           // 当前候选池
    let lastItem = null;     // 上次抽中的项

    // 工具
    function setErr(msg){
      errEl.textContent = msg;
      errEl.hidden = !msg;
    }
    function setDebug(msg){
      dbgEl.textContent = msg;
      dbgEl.hidden = !msg;
    }
    function chooseOne(arr){
      if(!arr || !arr.length) return null;
      const idx = Math.floor(Math.random()*arr.length);
      return arr[idx];
    }
    function safeArray(x){ return Array.isArray(x) ? x : []; }

    // 加载数据：直接请求 Google Script；把 sid 传过去让后端过滤，同时前端再做二次过滤
    async function loadList(){
      setErr('');
      setDebug('');
      ph.textContent = '読み込み中…';
      imgBox.hidden = true;

      const api = new URL(GOOGLE_SCRIPT);
      api.searchParams.set('spot', spot);
      api.searchParams.set('mode', 'list');
      if (sid) api.searchParams.set('sid', sid);  // 让 Apps Script 也过滤一次
      // 防止缓存（可选）
      api.searchParams.set('_t', Date.now());

      let raw;
      try{
        const resp = await fetch(api.toString(), { cache: 'no-store' });
        raw = await resp.text();
      }catch(e){
        setErr('ネットワークエラー：データを取得できません。');
        ph.textContent = '読み込みに失敗しました。再読込みしてください。';
        return;
      }

      // 期望标准形态：{"status":200, "data":[...]}
      let json;
      try{
        json = JSON.parse(raw);
      }catch(e){
        // 拿到了 HTML（例如 400/错误页），直接提示
        setErr('データ形式が正しくありません（JSON ではありません）。');
        setDebug(raw.slice(0, 200) + (raw.length>200 ? '…' : ''));
        ph.textContent = '読み込みに失敗しました。再読込みしてください。';
        return;
      }

      if (!json || typeof json !== 'object' || json.status !== 200){
        setErr('取得に失敗しました（status: ' + (json && json.status) + '）。');
        setDebug(JSON.stringify(json).slice(0, 300));
        ph.textContent = '読み込みに失敗しました。再読込みしてください。';
        return;
      }

      // 规范化列表
      const list = safeArray(json.data)
        .map(x => ({ id: String(x.id||''), img: String(x.img||''), text: String(x.text||'') }))
        .filter(x => !!x.img);

      // 再做一次“绝不抽到自己”的前端过滤
      const filtered = sid ? list.filter(x => x.id !== sid) : list;

      if (!filtered.length){
        ph.textContent = '投稿がまだ少ないみたい…';
        setErr('');
        return;
      }

      pool = filtered.slice();
      ph.textContent = '抽選中…';
      await drawOne(); // 首次展示
    }

    async function drawOne(){
      setErr('');
      if (!pool.length){
        ph.textContent = '投稿がまだ少ないみたい…';
        imgBox.hidden = true;
        return;
      }

      // 尽量避免连续重复（如果池子 >1）
      let item = chooseOne(pool);
      if (lastItem && pool.length > 1){
        const MAX_TRY = 6;
        let cnt = 0;
        while (item && lastItem && item.img === lastItem.img && cnt < MAX_TRY){
          item = chooseOne(pool);
          cnt++;
        }
      }
      lastItem = item;

      // 显示图片与文字
      await showItem(item);
    }

    function showItem(item){
      return new Promise((resolve) => {
        ph.textContent = '';
        txtEl.textContent = item.text || '';
        imgEl.onerror = null; // 清理旧的
        imgEl.src = '';       // 触发重载
        imgBox.hidden = false;

        let triedProxy = false;
        const directUrl = item.img;
        const proxyUrl  = IMG_PROXY(directUrl);

        imgEl.onload = () => { resolve(); };

        imgEl.onerror = () => {
          if (!triedProxy){
            triedProxy = true;
            imgEl.src = proxyUrl; // 直链失败 → 代理一次
          }else{
            setErr('画像の読み込みに失敗しました。');
            resolve();
          }
        };

        // 先走直链
        imgEl.src = directUrl;
      });
    }

    // “再投稿する”按钮：跳回フォーム或你的投稿页（这里保留现状：只是一个占位逻辑）
    again.addEventListener('click', () => {
      // TODO: 这里可以替换为你的投稿入口
      // 现在的行为：刷新本页再次抽（如果你希望跳表单，在此 location.href = '...'）
      location.reload();
    });

    // 进来就加载
    loadList();
  </script>
</body>
</html>
